<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="timeless">










<meta property="og:type" content="website">
<meta property="og:title" content="Timelessx">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Timelessx">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Timelessx">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





<script type="text/javascript">
    (function () {
        if ('') {
            if (prompt('请输入文章密码') !== '') {
                alert('您没有阅读权限');
                if (history.length === 1) {
                    window.location.href = '/';
                } else {
                    history.back();
                }
            }
        }
    })();
</script>
  <title>Timelessx</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Timelessx</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/12/Termux-Android上的高级终端模拟器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/12/Termux-Android上的高级终端模拟器/" itemprop="url">Termux-Android上的高级终端模拟器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-12T20:04:28+08:00">
                2018-05-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-05-12T20:19:33+08:00">
                2018-05-12
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近发现了一个Android下的非常好用的终端模拟器，之前一直用JuiceSSH也挺好用，Termux更加强大，一些基础及高级用法这篇文章讲的已经很详细了，</p>
<p><strong><a href="https://www.sqlsec.com/2018/05/termux.html#toc-heading-111" target="_blank" rel="noopener">https://www.sqlsec.com/2018/05/termux.html#toc-heading-111</a></strong><br><strong><a href="https://wiki.termux.com/wiki/FAQ" target="_blank" rel="noopener">https://wiki.termux.com/wiki/FAQ</a></strong></p>
<p>这里再补充一下第一篇文章没有介绍(英文wiki有介绍)的调出Termux特殊按键比如ctrl、alt、tab、方向键等的方法，我们手机输入法默认布局是没有这些按键的，我们可以换用<code>Hacker&#39;s Keyboard</code>输入法，<br>同时Termux也提供了这些额外按键支持，调出方法很简单第一种按住音量加键再按Q，第二种左滑，在弹出菜单中长按左下角KEYBOARD按钮。<br>这个额外的键盘还支持自定义，创建一个这样的配置文件<code>~/.termux/termux.properties</code>，里面可以定义一些按键：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extra-keys = [[&apos;ESC&apos;,&apos;/&apos;,&apos;-&apos;,&apos;:&apos;,&apos;UP&apos;,&apos;|&apos;,&apos;PGUP&apos;],[&apos;TAB&apos;,&apos;CTRL&apos;,&apos;ALT&apos;,&apos;LEFT&apos;,&apos;DOWN&apos;,&apos;RIGHT&apos;,&apos;PGDN&apos;]]</span><br></pre></td></tr></table></figure></p>
<p>这样就会显示两排常用按键非常方便。</p>
<p>手机上输入终究还是不尽人意，可以用adb端口转发将termux的ssh端口转发到电脑上，这样就可以直接在电脑上操作手机，termux安装openSSH后默认监听端口为8022，电脑连接不需要用户名密码，可以自己加个公钥方便以后连接。<br>adb端口转发也非常简单，先看adb命令帮助文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">forward --list           list all forward socket connections</span><br><span class="line">forward [--no-rebind] LOCAL REMOTE</span><br><span class="line">    forward socket connection using:</span><br><span class="line">      tcp:&lt;port&gt; (&lt;local&gt; may be &quot;tcp:0&quot; to pick any open port)</span><br><span class="line">      localabstract:&lt;unix domain socket name&gt;</span><br><span class="line">      localreserved:&lt;unix domain socket name&gt;</span><br><span class="line">      localfilesystem:&lt;unix domain socket name&gt;</span><br><span class="line">      dev:&lt;character device name&gt;</span><br><span class="line">      jdwp:&lt;process pid&gt; (remote only)</span><br><span class="line">forward --remove LOCAL   remove specific forward socket connection</span><br><span class="line">forward --remove-all     remove all forward socket connections</span><br><span class="line"></span><br><span class="line">reverse --list           list all reverse socket connections from device</span><br><span class="line">reverse [--no-rebind] REMOTE LOCAL</span><br><span class="line">    reverse socket connection using:</span><br><span class="line">      tcp:&lt;port&gt; (&lt;remote&gt; may be &quot;tcp:0&quot; to pick any open port)</span><br><span class="line">      localabstract:&lt;unix domain socket name&gt;</span><br><span class="line">      localreserved:&lt;unix domain socket name&gt;</span><br><span class="line">      localfilesystem:&lt;unix domain socket name&gt;</span><br><span class="line">reverse --remove REMOTE  remove specific reverse socket connection</span><br><span class="line">reverse --remove-all     remove all reverse socket connections from device</span><br></pre></td></tr></table></figure></p>
<p>adb还支持反向端口转发，这不是本文的重点，adb端口转发使用非常简单，手机USB调试打开连接电脑，然后运行下面命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:8022 tcp:8022</span><br></pre></td></tr></table></figure></p>
<p>这样手机8022端口就被转发到电脑8022端口，接下来再用电脑ssh连接本地8022就能连接上手机操作就很方便了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/17/微信接收异常通知/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/17/微信接收异常通知/" itemprop="url">微信接收异常通知</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-17T15:52:18+08:00">
                2017-09-17
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-09-18T17:37:22+08:00">
                2017-09-18
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>想图方便可以直接用<a href="http://sc.ftqq.com" target="_blank" rel="noopener">Server酱</a>或者<a href="http://pushbear.ftqq.com" target="_blank" rel="noopener">PushBear</a><br>想不受限制灵活使用就要自己动手。</p>
<p>由于系统日志采集系统使用不是很方便，邮件通知也不太及时，就想再加个钉钉和微信错误异常日志通知。<br>钉钉机器人Webhook使用非常简单方便，但是微信就很恶心了。<br>搜了一些资料要么写的啰里啰嗦避重就轻，要么写的含糊不清废话连篇，<br>于是就自己看了下公众号文档，发现微信公众号想要不受限制主动发送消息给用户只能使用服务号的模板消息功能，<br>单纯想发个通知还要再去申请一个服务号显然大材小用，不过微信还提供了一个接口测试号可以直接使用服务号才有的部分功能，<br>当然了已经有服务号的话也可以直接用<br><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421137522" target="_blank" rel="noopener">https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421137522</a><br><a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="noopener">https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login</a><br><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433751277" target="_blank" rel="noopener">https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433751277</a></p>
<p>文档太多就不一步一步介绍了，直接抽取最关键两步:</p>
<ol>
<li>get获取access_token，<a href="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=appid&amp;secret=appsecret" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=appid&amp;secret=appsecret</a></li>
<li>post发送消息<a href="https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=access_token" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=access_token</a></li>
</ol>
<p>假如我们创建了这样一个模板:<br><code>异常日志通知	时间: {{time.DATA}} {{log.DATA}}</code><br>那么发送消息格式为:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"template_id"</span>:<span class="string">"3HP5qQw2XvVPVK8kPwEsSRxEDYVdWaY2o7Y_wA-bKSw"</span>,</span><br><span class="line">    <span class="attr">"touser"</span>:<span class="string">"openid"</span>,</span><br><span class="line">    <span class="attr">"url"</span>:<span class="string">"***.io"</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"log"</span>:&#123;</span><br><span class="line">            <span class="attr">"value"</span>:<span class="string">"exception"</span>,</span><br><span class="line">            <span class="attr">"color"</span>:<span class="string">"#f92672"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"time"</span>:&#123;</span><br><span class="line">            <span class="attr">"value"</span>:<span class="string">"2017-09-17 15:19:19"</span>,</span><br><span class="line">            <span class="attr">"color"</span>:<span class="string">"#ff0080"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>顺便附上工具类WechatLoggerTool</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众帐号测试号: https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login</span></span><br><span class="line"><span class="comment"> * 模板   异常日志通知	时间: &#123;&#123;time.DATA&#125;&#125; &#123;&#123;log.DATA&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatLoggerTool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APPID = <span class="string">"***"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APPSECRET = <span class="string">"***"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEMPLATE_ID = <span class="string">"3HP5qQw2XvVPVK8kPwEsSRxEDYVdWaY2o7Y_wA-bKSw"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleDateFormat formater = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> TTL = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">72</span>;    <span class="comment">//关注用户列表缓存3天</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        getInstance().sendLogger(<span class="string">"key"</span>,<span class="string">"message"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WechatLoggerTool instance = <span class="keyword">new</span> WechatLoggerTool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WechatLoggerTool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WechatLoggerTool <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendLogger</span><span class="params">(String id, String log)</span> </span>&#123;</span><br><span class="line">        String access_token = getAccessToken();</span><br><span class="line">        String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token="</span> + access_token;</span><br><span class="line">        String log_link = Env.dev ? <span class="string">"***?id="</span> + id : <span class="string">"***?id="</span> + id;</span><br><span class="line">        List&lt;String&gt; userList = getUserList(access_token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userList != <span class="keyword">null</span> &amp;&amp; userList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String openid : userList) &#123;</span><br><span class="line">                WXTemplateData data = <span class="keyword">new</span> WXTemplateData();</span><br><span class="line">                data.log = <span class="keyword">new</span> WXTemplateInfo(log, <span class="string">"#f92672"</span>);</span><br><span class="line">                data.time = <span class="keyword">new</span> WXTemplateInfo(formater.format(<span class="keyword">new</span> Date()));</span><br><span class="line"></span><br><span class="line">                Map map = <span class="keyword">new</span> HashMap(<span class="number">8</span>);</span><br><span class="line">                map.put(<span class="string">"touser"</span>, openid);</span><br><span class="line">                map.put(<span class="string">"template_id"</span>, TEMPLATE_ID);</span><br><span class="line">                map.put(<span class="string">"url"</span>, log_link);</span><br><span class="line">                map.put(<span class="string">"data"</span>, data);</span><br><span class="line"></span><br><span class="line">                HttpManager.getInstance().postJson(url, JsonMapper.getInstance().toJson(map));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToUser</span><span class="params">(String openid, String id, String log)</span> </span>&#123;</span><br><span class="line">        String access_token = getAccessToken();</span><br><span class="line">        String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token="</span> + access_token;</span><br><span class="line">        String log_link = Env.dev ? <span class="string">"***?id="</span> + id : <span class="string">"***?id="</span> + id;</span><br><span class="line"></span><br><span class="line">        WXTemplateData data = <span class="keyword">new</span> WXTemplateData();</span><br><span class="line">        data.log = <span class="keyword">new</span> WXTemplateInfo(log, <span class="string">"#f92672"</span>);</span><br><span class="line">        data.time = <span class="keyword">new</span> WXTemplateInfo(formater.format(<span class="keyword">new</span> Date()));</span><br><span class="line"></span><br><span class="line">        Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">"touser"</span>, openid);</span><br><span class="line">        map.put(<span class="string">"template_id"</span>, TEMPLATE_ID);</span><br><span class="line">        map.put(<span class="string">"url"</span>, log_link);</span><br><span class="line">        map.put(<span class="string">"data"</span>, data);</span><br><span class="line"></span><br><span class="line">        HttpManager.getInstance().postJson(url, JsonMapper.getInstance().toJson(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getUserList</span><span class="params">(String access_token)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = CacheManager.getInstance().get(<span class="string">"wechat_logger_users"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span> || list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            String url = String.format(<span class="string">"https://api.weixin.qq.com/cgi-bin/user/get?access_token=%s"</span>, access_token);</span><br><span class="line">            String response = HttpManager.get(url);</span><br><span class="line">            Map map = JsonMapper.getInstance().toMap(response);</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object data = map.get(<span class="string">"data"</span>);</span><br><span class="line">                <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    list = (List) ((Map) data).get(<span class="string">"openid"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (list != <span class="keyword">null</span>)</span><br><span class="line">                        CacheManager.getInstance().put(<span class="string">"wechat_logger_users"</span>, list, TTL);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAccessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object access_token = CacheManager.getInstance().get(<span class="string">"wechat_logger_access_token"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (access_token == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String url = String.format(<span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=%s&amp;secret=%s"</span>, APPID, APPSECRET);</span><br><span class="line">            String result = HttpManager.get(url);</span><br><span class="line">            Map map = JsonMapper.getInstance().toMap(result);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                access_token = map.get(<span class="string">"access_token"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (access_token != <span class="keyword">null</span>)</span><br><span class="line">                    CacheManager.getInstance().put(<span class="string">"wechat_logger_access_token"</span>, access_token, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">90</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> String.valueOf(access_token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WXTemplateData</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> WXTemplateInfo log;</span><br><span class="line">        <span class="keyword">private</span> WXTemplateInfo time;</span><br><span class="line"></span><br><span class="line">        WXTemplateData() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> WXTemplateInfo <span class="title">getLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> log;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLog</span><span class="params">(WXTemplateInfo log)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.log = log;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> WXTemplateInfo <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTime</span><span class="params">(WXTemplateInfo time)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.time = time;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WXTemplateInfo</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line">        <span class="keyword">private</span> String color;</span><br><span class="line"></span><br><span class="line">        WXTemplateInfo() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WXTemplateInfo(String value) &#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WXTemplateInfo(String value, String color) &#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">            <span class="keyword">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(String color)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/22/Spring Mybatis读写分离/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/22/Spring Mybatis读写分离/" itemprop="url">Spring Mybatis读写分离</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-22T16:11:38+08:00">
                2017-05-22
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-05-22T16:58:12+08:00">
                2017-05-22
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在项目中有一些模块对数据实时性要求不高，为了减少对数据库的压力，需要做一下读写分离，由于是老项目，为了尽量减少对代码入侵，所以这里就借助Spring提供的AbstractRoutingDataSource动态切换多个数据源，再通过Mybatis插件来选择执行不同语句时使用哪个数据源，这样就可以做到只修改一下配置文件数据源无需对之前代码做任何修改就能达到读写分离。</p>
<p>首先修改Master的配置文件my.cnf，mysqld命令帮助文档里面提到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Default options are read from the following files in the given order:</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf /usr/local/mysql/etc/my.cnf ~/.my.cnf</span><br></pre></td></tr></table></figure></p>
<p>可以看到mysql读取配置文件路径及默认顺序，我们根据自己使用的文件修改配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">#server_id一定要唯一，一般都设置成ip便于记忆维护</span><br><span class="line">server_id=10</span><br><span class="line"></span><br><span class="line">#开启二进制日志支持，一般为了便于误删除后数据恢复，binlog都是开启的</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">#日志的格式（mixed,statement,row，默认格式是mixed）</span><br><span class="line">binlog_format=mixed</span><br><span class="line"></span><br><span class="line">#忽略指定数据库不同步</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line"></span><br><span class="line">#为每个session分配的内存，在事务过程中用来存储二进制日志的缓存</span><br><span class="line">binlog_cache_size=1M</span><br><span class="line"></span><br><span class="line">#跳过主从复制过程中遇到的指定类型的错误避免slave端复制中断停止同步，比如1062主键重复错误</span><br><span class="line">slave_skip_errors=1062</span><br></pre></td></tr></table></figure></p>
<p>再创建一个专门用于数据同步的用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create user &apos;slave&apos;@&apos;192.168.10.20&apos; identified by &apos;654321&apos;;</span><br><span class="line">grant replication slave, replication client on *.* to &apos;slave&apos;@&apos;192.168.10.20&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p>
<p>这里创建一个用户并不是必须步骤，主要是要授予这个用户REPLICATION SLAVE、REPLICATION CLIENT权限。主库已经配置好了，可以运行<code>show master status</code>查看一下。</p>
<p>接下来配置从库，从库也需要修改配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">#从库设置只读</span><br><span class="line">read_only=1</span><br><span class="line"></span><br><span class="line">server_id=20</span><br><span class="line"></span><br><span class="line">#从库也开启二进制日志功能，在主库宕机时从库可以切换作为主库使用</span><br><span class="line">log-bin=mysql-slave-bin</span><br><span class="line"></span><br><span class="line">relay_log=mysql-relay-bin</span><br><span class="line"></span><br><span class="line">#binlog-ignore-db=mysql</span><br><span class="line"></span><br><span class="line">#将slave复制事件记录到二进制日志</span><br><span class="line">log_slave_updates=1</span><br><span class="line"></span><br><span class="line">slave_skip_errors=1062</span><br></pre></td></tr></table></figure></p>
<p>从库关联到主库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST =&apos;192.168.10.10&apos;,</span><br><span class="line">    MASTER_PORT =3306,</span><br><span class="line">    MASTER_USER =&apos;slave&apos;,</span><br><span class="line">    MASTER_PASSWORD =&apos;654321&apos;;</span><br></pre></td></tr></table></figure></p>
<p>运行<code>start slave</code>，如果没有配置错误的话主从就设置好了，可以运行<code>show slave status\G</code>查看从库状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                Slave_IO_State: Waiting for master to send event</span><br><span class="line">                   Master_Host: 192.168.10.10</span><br><span class="line">                   Master_User: slave</span><br><span class="line">                   Master_Port: 3306</span><br><span class="line">                 Connect_Retry: 60</span><br><span class="line">               Master_Log_File: bin_log.000018</span><br><span class="line">           Read_Master_Log_Pos: 828957782</span><br><span class="line">                Relay_Log_File: relay-bin.000022</span><br><span class="line">                 Relay_Log_Pos: 464061429</span><br><span class="line">         Relay_Master_Log_File: bin_log.000018</span><br><span class="line">              Slave_IO_Running: Yes</span><br><span class="line">             Slave_SQL_Running: Yes</span><br><span class="line">               Replicate_Do_DB: </span><br><span class="line">           Replicate_Ignore_DB: </span><br><span class="line">            Replicate_Do_Table: </span><br><span class="line">        Replicate_Ignore_Table: </span><br><span class="line">       Replicate_Wild_Do_Table: </span><br><span class="line">   Replicate_Wild_Ignore_Table: </span><br><span class="line">                    Last_Errno: 0</span><br><span class="line">                    Last_Error: </span><br><span class="line">                  Skip_Counter: 0</span><br><span class="line">           Exec_Master_Log_Pos: 828957782</span><br><span class="line">               Relay_Log_Space: 464061732</span><br><span class="line">               Until_Condition: None</span><br><span class="line">                Until_Log_File: </span><br><span class="line">                 Until_Log_Pos: 0</span><br><span class="line">            Master_SSL_Allowed: No</span><br><span class="line">            Master_SSL_CA_File: </span><br><span class="line">            Master_SSL_CA_Path: </span><br><span class="line">               Master_SSL_Cert: </span><br><span class="line">             Master_SSL_Cipher: </span><br><span class="line">                Master_SSL_Key: </span><br><span class="line">         Seconds_Behind_Master: 0</span><br><span class="line"> Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                 Last_IO_Errno: 0</span><br><span class="line">                 Last_IO_Error: </span><br><span class="line">                Last_SQL_Errno: 0</span><br><span class="line">                Last_SQL_Error: </span><br><span class="line">   Replicate_Ignore_Server_Ids: </span><br><span class="line">              Master_Server_Id: 1</span><br><span class="line">                Master_SSL_Crl: </span><br><span class="line">            Master_SSL_Crlpath: </span><br><span class="line">                    Using_Gtid: No</span><br><span class="line">                   Gtid_IO_Pos: </span><br><span class="line">       Replicate_Do_Domain_Ids: </span><br><span class="line">   Replicate_Ignore_Domain_Ids: </span><br><span class="line">                 Parallel_Mode: conservative</span><br><span class="line">                     SQL_Delay: 0</span><br><span class="line">           SQL_Remaining_Delay: NULL</span><br><span class="line">       Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">              Slave_DDL_Groups: 0</span><br><span class="line">Slave_Non_Transactional_Groups: 0</span><br><span class="line">    Slave_Transactional_Groups: 0</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>那如果我们想在本地只用自己一台电脑怎么模拟主从环境了，我是这样做的，本地运行多个mysql实例，我本地安装的mysql都是下载的tar解压手动安装的，mysqld可以指定很多命令参数灵活运行，这里主要指定使用不同的配置文件，<br>启动主库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/x/mysql-5.5.58/bin/mysqld --defaults-file=/home/x/master.cnf --basedir=/home/x/mysql-5.5.58 --datadir=/home/x/mysql-5.5.58/data --plugin-dir=/home/x/mysql-5.5.58/lib/plugin --pid-file=X.pid --socket=/tmp/mysql.sock --port=3306</span><br></pre></td></tr></table></figure></p>
<p>启动从库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/x/mysql-5.5.58/bin/mysqld --defaults-file=/home/x/slave.cnf --basedir=/home/x/mysql-5.5.58 --datadir=/home/x/mysql-5.5.58/slave --socket=/tmp/slave.sock --port=3307</span><br></pre></td></tr></table></figure></p>
<p>安装的一份mysql指定不同配置文件运行多个实例。</p>
<p>准备工作已经完毕，接下来就是代码阶段了，首先修改spring数据源配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"baseDataSource"</span> <span class="attr">class</span>=<span class="string">"***"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里放的是数据源公共配置参数--&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 主库 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"masterDataSource"</span> <span class="attr">parent</span>=<span class="string">"baseDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;master_jdbc_url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;master_jdbc_username&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;master_jdbc_password&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 从库1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"slaveDataSource1"</span> <span class="attr">parent</span>=<span class="string">"baseDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_url1&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_username1&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_password1&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 从库2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"slaveDataSource2"</span> <span class="attr">parent</span>=<span class="string">"baseDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_url2&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_username2&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;slave_jdbc_password2&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dynamicDataSource"</span> <span class="attr">class</span>=<span class="string">"x.x.DynamicDataSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"master"</span> <span class="attr">ref</span>=<span class="string">"masterDataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"slaves"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"slaveDataSource1"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"slaveDataSource2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dynamicDataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span> <span class="attr">value</span>=<span class="string">"classpath:mapper/*.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"x.x.DynamicDataSource.DynamicDataSourceInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>配置多个数据源，再通过继承AbstractRoutingDataSource实现determineCurrentLookupKey()方法来动态决定使用哪个数据源：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读写分离</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource master;  <span class="comment">// 主库一个</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;DataSource&gt; slaves;    <span class="comment">//从库可以设置多个</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> slave_count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicDataSource</span><span class="params">(DataSource master, List&lt;DataSource&gt; slaves)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (master == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Master DataSource can't be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.master = master;</span><br><span class="line">        <span class="keyword">this</span>.slaves = slaves;</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">        targetDataSources.put(DatabaseType.master.name, master);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slaves != <span class="keyword">null</span> &amp;&amp; slaves.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            slave_count = slaves.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; slave_count; i++) &#123;</span><br><span class="line">                targetDataSources.put(DatabaseType.slave.name + i, slaves.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setDefaultTargetDataSource(master);</span><br><span class="line">        setTargetDataSources(targetDataSources);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DatabaseType type = DatabaseContextHolder.getDatabaseType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == DatabaseType.slave &amp;&amp; slave_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            DatabaseContextHolder.clearDbType();    <span class="comment">//清除数据源设置</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">int</span> index = random.nextInt(slave_count);</span><br><span class="line">            logger.info(<span class="string">"&lt;&lt;&lt;&lt;&lt;&lt;使用读库: "</span> + DatabaseType.slave.name + index);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> DatabaseType.slave.name + index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;使用写库: master"</span>);</span><br><span class="line">        </span><br><span class="line">        DatabaseContextHolder.clearDbType();    <span class="comment">//清除数据源设置</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DatabaseType.master.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getMaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> master;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaster</span><span class="params">(DataSource master)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.master = master;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;DataSource&gt; <span class="title">getSlaves</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> slaves;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSlaves</span><span class="params">(List&lt;DataSource&gt; slaves)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.slaves = slaves;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> DatabaseType &#123;</span><br><span class="line">        master(<span class="string">"write"</span>),</span><br><span class="line">        slave(<span class="string">"read"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        DatabaseType(String name) &#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseContextHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DatabaseType&gt; _context = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDatabaseType</span><span class="params">(DatabaseType type)</span> </span>&#123;</span><br><span class="line">            _context.set(type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DatabaseType <span class="title">getDatabaseType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            DatabaseType type = _context.get();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == <span class="keyword">null</span>)</span><br><span class="line">                type = DatabaseType.master;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearDbType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//System.out.println("&gt;&gt;&gt;&gt;&gt;&gt;回收DatabaseType");</span></span><br><span class="line">            _context.remove();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Intercepts</span>(&#123;</span><br><span class="line">            <span class="meta">@Signature</span>(type = Executor.class, method = <span class="string">"update"</span>, args = &#123;MappedStatement.class, Object.class&#125;),</span><br><span class="line">            <span class="meta">@Signature</span>(type = Executor.class, method = <span class="string">"query"</span>, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX = <span class="string">".*?insert\\u0020.*?|.*?delete\\u0020.*?|.*?update\\u0020.*?"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, DatabaseType&gt; cache_map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            DatabaseType databaseType;</span><br><span class="line">            <span class="keyword">boolean</span> synchronizationActive = TransactionSynchronizationManager.isSynchronizationActive();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!synchronizationActive) &#123;</span><br><span class="line">                Object[] args = invocation.getArgs();</span><br><span class="line">                MappedStatement ms = (MappedStatement) args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((databaseType = cache_map.get(ms.getId())) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ms.getSqlCommandType().equals(SqlCommandType.SELECT)) &#123;</span><br><span class="line">                        <span class="comment">//!selectKey自增id查询主键(SELECT LAST_INSERT_ID() )方法使用主库</span></span><br><span class="line">                        <span class="keyword">if</span> (ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX)) &#123;</span><br><span class="line">                            databaseType = DatabaseType.master;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            BoundSql boundSql = ms.getSqlSource().getBoundSql(args[<span class="number">1</span>]);</span><br><span class="line">                            String sql = boundSql.getSql().toLowerCase().replaceAll(<span class="string">"[\\t\\n\\r]"</span>, <span class="string">" "</span>);</span><br><span class="line">                            databaseType = sql.matches(REGEX) ? DatabaseType.master : DatabaseType.slave;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        databaseType = DatabaseType.master;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    cache_map.put(ms.getId(), databaseType);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//System.out.printf("###方法%s use %s, SqlCommandType: %s###\n", ms.getId(), databaseType.name(), ms.getSqlCommandType().name());</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//只读事务用读库,读写事务用写库</span></span><br><span class="line">                <span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">                databaseType = readOnly ? DatabaseType.slave : DatabaseType.master;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            DatabaseContextHolder.setDatabaseType(databaseType);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Executor)</span><br><span class="line">                <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> target;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>经过以上设置，只需要稍微修改一下旧项目配置文件，再添加一个类就能做到读写分离，不需要修改老代码是不是很方便，觉得写的内容有帮助的话还不赶紧follow一下我的github，虽然更新的不快，但内容质量都是有保证的，绝不是那些随便百度就能搜索到的东西。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/09/mysql统计动态生成日期表没有数据补0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/09/mysql统计动态生成日期表没有数据补0/" itemprop="url">mysql统计动态生成日期表没有数据补0</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-09T14:26:49+08:00">
                2017-04-09
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-04-09T14:37:11+08:00">
                2017-04-09
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实现此功能方法有很多种，项目中有在java代码中手动拼接日期的也有用存储过程的，这里介绍一种更精炼的方法，来自<br><strong><a href="https://stackoverflow.com/questions/3538858/mysql-how-to-fill-missing-dates-in-range" target="_blank" rel="noopener">https://stackoverflow.com/questions/3538858/mysql-how-to-fill-missing-dates-in-range</a></strong><br><strong><a href="https://stackoverflow.com/questions/34545056/mysql-fill-in-missing-dates-between-two-dates-for-a-given-status" target="_blank" rel="noopener">https://stackoverflow.com/questions/34545056/mysql-fill-in-missing-dates-between-two-dates-for-a-given-status</a></strong></p>
<p>首先执行下面sql可以生成一个连续范围日期：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">SELECT curdate() - INTERVAL (n1.num + (10 * n2.num) + (100 * n3.num)) DAY AS `date`</span><br><span class="line">FROM (SELECT 9 AS num</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 8</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 7</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 6</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 5</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 4</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 3</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 2</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 1</span><br><span class="line">      UNION ALL</span><br><span class="line">      SELECT 0) AS n1</span><br><span class="line">       CROSS JOIN (SELECT 9 AS num</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 8</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 7</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 6</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 5</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 4</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 3</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 2</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 1</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 0) AS n2</span><br><span class="line">       CROSS JOIN (SELECT 9 AS num</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 8</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 7</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 6</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 5</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 4</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 3</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 2</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 1</span><br><span class="line">                   UNION ALL</span><br><span class="line">                   SELECT 0) AS n3;</span><br></pre></td></tr></table></figure></p>
<p>由于CROSS JOIN了3次n1.num + (10 <em> n2.num) + (100 </em> n3.num)就能产生从0到999范围的值，curdate() - INTERVAL (n1.num + (10 <em> n2.num) + (100 </em> n3.num))就能产生从当前日期到1000天以前范围的连续日期。</p>
<p>每次写这么长语句太啰嗦麻烦也不利于阅读，可以将0-9数字放入一张表或创建一个view：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW number AS</span><br><span class="line">  SELECT 9 AS num</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 8</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 7</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 6</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 5</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 4</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 3</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 2</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 1</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT 0;</span><br></pre></td></tr></table></figure></p>
<p>那么上面语句就能简化为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT curdate() - INTERVAL (n1.num + (10 * n2.num) + (100 * n3.num)) DAY AS `date`</span><br><span class="line">FROM `number` AS n1</span><br><span class="line">       CROSS JOIN `number` AS n2</span><br><span class="line">       CROSS JOIN `number` AS n3;</span><br></pre></td></tr></table></figure></p>
<p>那么想要查询一段时间内每天有多少用户注册的一个最简单例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT date_format(days.date, &apos;%Y/%m/%d&apos;) AS `date`,</span><br><span class="line">       IF(u.count IS NULL, 0, u.count)    AS &apos;count&apos;</span><br><span class="line">FROM (SELECT days.date</span><br><span class="line">      FROM (SELECT curdate() - INTERVAL (n1.num + (10 * n2.num) + (100 * n3.num)) DAY AS `date`</span><br><span class="line">            FROM `number` AS n1</span><br><span class="line">                   CROSS JOIN `number` AS n2</span><br><span class="line">                   CROSS JOIN `number` AS n3) AS days</span><br><span class="line">      WHERE `date` BETWEEN &apos;2017-01-01&apos;</span><br><span class="line">              AND `date` &lt;= &apos;2017-02-01&apos;) AS days</span><br><span class="line">       LEFT JOIN (SELECT DATE(creat_time) AS `date`,</span><br><span class="line">                         count(0)         AS `count`</span><br><span class="line">                  FROM user_info</span><br><span class="line">                  WHERE `date` BETWEEN &apos;2017-01-01&apos;</span><br><span class="line">                          AND &apos;2017-02-01&apos;</span><br><span class="line">                  GROUP BY date</span><br><span class="line">                  ORDER BY date) AS u ON days.date = u.date;</span><br></pre></td></tr></table></figure></p>
<p>想要控制生成日期范围只要控制CROSS JOIN次数和number个数就能生成任意长度的连续范围日期是不是很方便，类似的还有生成一天24小时时间段范围数据也可以使用类似方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/21/N个线程交替运行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/21/N个线程交替运行/" itemprop="url">N个线程交替运行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-21T15:04:16+08:00">
                2017-03-21
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-03-21T15:08:21+08:00">
                2017-03-21
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前面试时遇到一个考察多线程的问题-如何让N个线程交替运行，这里就记录一下。</p>
<p><strong>实现方法有多种，首先从最基本的synchronized、wait、notify开始：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> cur = i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> index = cur;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                        <span class="keyword">while</span> (start != index)</span><br><span class="line">                            lock.wait();</span><br><span class="line">                            </span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">"线程 "</span> + cur + <span class="string">" 执行中"</span>);</span><br><span class="line">                            Thread.sleep((<span class="keyword">long</span>) (<span class="number">2000</span> * Math.random()));    <span class="comment">//模拟耗时操作</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        start = (start + <span class="number">1</span>) % n;</span><br><span class="line">                        lock.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>用Lock接口实现：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">final</span> Condition[] conditions = <span class="keyword">new</span> Condition[n];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        conditions[i] = lock.newCondition();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cur = i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                    lock.lock();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">while</span> (next != cur)</span><br><span class="line">                            conditions[cur].await();</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">"线程 "</span> + cur + <span class="string">" 执行中"</span>);</span><br><span class="line">                        Thread.sleep((<span class="keyword">long</span>) (<span class="number">2000</span> * Math.random()));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        next = (cur + <span class="number">1</span>) % n;</span><br><span class="line">                        conditions[next].signal();</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ReentrantLock可以模仿上面synchronized一样的写法，这里用了另外一种写法借助Condition更加准确signal要唤醒的线程。</p>
<p><strong>用信号量Semaphore实现：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Semaphore[] semaphore = <span class="keyword">new</span> Semaphore[n];</span><br><span class="line">    semaphore[<span class="number">0</span>] = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</span><br><span class="line">            semaphore[i] = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cur = i;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        semaphore[cur].acquire();</span><br><span class="line">                        System.out.println(<span class="string">"线程 "</span> + cur + <span class="string">" 执行中"</span>);</span><br><span class="line">                        Thread.sleep((<span class="keyword">long</span>) (<span class="number">2000</span> * Math.random()));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        semaphore[(cur + <span class="number">1</span>) % n].release();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/02/Spring统一异常处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/02/Spring统一异常处理/" itemprop="url">Spring统一异常处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-02T16:22:07+08:00">
                2017-03-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-03-03T17:18:20+08:00">
                2017-03-03
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>接手了旧项目，代码看了一下引起极度不适，大面积啰里啰嗦重复无用代码，都是一些乱七八糟无关紧要的垃圾，各种层层try-catch，<br>代码也都是一坨没有空行分割，一眼看去就找不到关键有用部分，满屏都是类似这种狗屎一样的东西 <img src="/images/shit.png" alt="垃圾"></p>
<p>于是一怒之下就总结了本文。</p>
<hr>
<ol>
<li>首先是统一异常处理，这里主要是利用@ControllerAdvice结合@ExceptionHandler来统一捕获Controller层调用抛出的异常，<br>使用了此方法Controller除特殊情况Exception需单独处理外其他就不需要再各种try-catch了。<br>还是老规矩废话不多说直接上代码吧，有码有真相</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异常统一处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandlerImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisService redisService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123;Exception.class&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseWrapper <span class="title">handleException</span><span class="params">(Exception e, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String message = e.getMessage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AbortException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.fail(((AbortException) e).getCode(), message);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InvalidArgumentException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.fail(((InvalidArgumentException) e).getCode(), message);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MissingServletRequestParameterException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.result(<span class="number">401</span>, <span class="string">"必要参数缺失: "</span> + ((MissingServletRequestParameterException) e).getParameterName());</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodArgumentTypeMismatchException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.fail(<span class="number">400</span>, String.format(<span class="string">"参数类型错误: %s=%s, 正确类型: %s"</span>, ((MethodArgumentTypeMismatchException) e).getName(), ((MethodArgumentTypeMismatchException) e).getValue(), ((MethodArgumentTypeMismatchException) e).getRequiredType().getSimpleName()));</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NoHandlerFoundException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.fail(<span class="number">404</span>, String.format(<span class="string">"接口地址错误: %s"</span>, ((NoHandlerFoundException) e).getRequestURL()));</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> HttpRequestMethodNotSupportedException)</span><br><span class="line">            <span class="keyword">return</span> ResponseWrapper.fail(<span class="number">500</span>,<span class="string">"请检查接口是get还是post"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Map&lt;String, ?&gt; map = request.getParameterMap();</span><br><span class="line">                sb.append(request.getRequestURI())</span><br><span class="line">                        .append(<span class="string">"\n\n"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, ?&gt; entry : map.entrySet()) &#123;</span><br><span class="line">                    sb.append(entry.getKey()).append(<span class="string">": "</span>);</span><br><span class="line">                    Object v = entry.getValue();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (v <span class="keyword">instanceof</span> String[]) &#123;</span><br><span class="line">                        String[] values = (String[]) v;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//通常情况下参数的值只有一个</span></span><br><span class="line">                        <span class="keyword">if</span> (values.length &gt; <span class="number">0</span>)</span><br><span class="line">                            sb.append(values[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//当参数的值有多个时用逗号分隔拼接起来</span></span><br><span class="line">                        <span class="keyword">if</span> (values.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">                                sb.append(<span class="string">','</span>)</span><br><span class="line">                                        .append(values[i]);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span></span><br><span class="line">                        sb.append(v);</span><br><span class="line"></span><br><span class="line">                    sb.append(<span class="string">'\n'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//直接e.printStackTrace()会打印到System.err标准错误输出，性能影响较大,尤其是并发较大时</span></span><br><span class="line">            <span class="comment">//通过PrintWriter包装CharArrayWriter打印到字符数组内存块中，大幅提升性能</span></span><br><span class="line">            CharArrayWriter cw = <span class="keyword">new</span> CharArrayWriter(<span class="number">1024</span>);</span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(cw, <span class="keyword">true</span>);</span><br><span class="line">            e.printStackTrace(pw);</span><br><span class="line">            </span><br><span class="line">            sb.append(<span class="string">'\n'</span>).append(cw.toCharArray());</span><br><span class="line">            String log = sb.toString();</span><br><span class="line">            String key = String.valueOf(System.currentTimeMillis());</span><br><span class="line">            redisService.set(key, log, <span class="number">20</span>, TimeUnit.DAYS);</span><br><span class="line"></span><br><span class="line">            StackTraceElement[] stackTrace = e.getStackTrace();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (stackTrace != <span class="keyword">null</span> &amp;&amp; stackTrace.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                StackTraceElement element = stackTrace[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                message = element.getClassName()</span><br><span class="line">                        + <span class="string">':'</span></span><br><span class="line">                        + element.getLineNumber()</span><br><span class="line">                        + <span class="string">" "</span></span><br><span class="line">                        + element.getMethodName()</span><br><span class="line">                        + <span class="string">"() "</span> + e.toString();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (Env.dev)</span><br><span class="line">                L.d(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseWrapper.error(<span class="number">400</span>, <span class="string">"系统异常"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<ol start="2">
<li>然后Response是包装一下，看到了各种脑残map.put()来当返回就想吐<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseWrapper</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> SUCCESS_CODE = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; ext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper(SUCCESS_CODE, <span class="string">"success"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseWrapper <span class="title">success</span><span class="params">(T result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper&lt;&gt;(SUCCESS_CODE, <span class="string">"success"</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseWrapper <span class="title">success</span><span class="params">(String message, T result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper&lt;&gt;(SUCCESS_CODE, message, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseWrapper <span class="title">success</span><span class="params">(String message, T result, Map&lt;String, Object&gt; extra)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper&lt;&gt;(SUCCESS_CODE, message, result, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">fail</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper(errorCode.getCode(), errorCode.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">fail</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper(<span class="number">400</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">fail</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper(code, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">error</span><span class="params">(<span class="keyword">int</span> code, String message, String error)</span> </span>&#123;</span><br><span class="line">        ResponseWrapper wrapper = <span class="keyword">new</span> ResponseWrapper(code, message);</span><br><span class="line">        wrapper.error = error;</span><br><span class="line">        <span class="keyword">return</span> wrapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseWrapper <span class="title">result</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper(code, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseWrapper <span class="title">result</span><span class="params">(<span class="keyword">int</span> code, String message, T result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper&lt;&gt;(code, message, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseWrapper <span class="title">result</span><span class="params">(<span class="keyword">int</span> code, String message, T result, Map&lt;String, Object&gt; extra)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseWrapper&lt;&gt;(code, message, result, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = SUCCESS_CODE;</span><br><span class="line">        <span class="keyword">this</span>.message = <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseWrapper</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseWrapper</span><span class="params">(<span class="keyword">int</span> code, String message, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseWrapper</span><span class="params">(<span class="keyword">int</span> code, String message, T data, Map&lt;String, Object&gt; ext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.ext = ext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getExt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExt</span><span class="params">(Map&lt;String, Object&gt; ext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ext = ext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p>当然，错误码也统一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ErrorCode &#123;</span><br><span class="line"></span><br><span class="line">    TOKEN_ERROR(<span class="number">400</span>, <span class="string">"Token异常"</span>),</span><br><span class="line">    RATELIMIT(<span class="number">401</span>, <span class="string">"请求频率过快"</span>),</span><br><span class="line">    SYSTEM_ERROR(<span class="number">500</span>, <span class="string">"系统错误"</span>),</span><br><span class="line">    SQL_ERROR(<span class="number">501</span>, <span class="string">"数据库错误"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    ErrorCode(<span class="keyword">int</span> code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p><strong><em>上面有一点与众不同的是：</em></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CharArrayWriter cw = <span class="keyword">new</span> CharArrayWriter(<span class="number">1024</span>);</span><br><span class="line">PrintWriter pw = <span class="keyword">new</span> PrintWriter(cw, <span class="keyword">true</span>);</span><br><span class="line">e.printStackTrace(pw);</span><br></pre></td></tr></table></figure></p>
<p>通常大多数人都是随手直接<code>e.printStackTrace()</code>，这样写虽然没有什么问题，但是性能影响较大，<br>跟进Throwable-&gt;printStackTrace()方法发现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Throwable</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        printStackTrace(System.err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">(PrintStream s)</span> </span>&#123;</span><br><span class="line">        printStackTrace(<span class="keyword">new</span> WrappedPrintStream(s));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">(PrintStreamOrWriter s)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (s.lock()) &#123;</span><br><span class="line">            <span class="comment">//Print our stack trace</span></span><br><span class="line">            s.println(<span class="keyword">this</span>);</span><br><span class="line">            </span><br><span class="line">            StackTraceElement[] trace = getOurStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement traceElement : trace)</span><br><span class="line">                s.println(<span class="string">"\tat "</span> + traceElement);</span><br><span class="line">                </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WrappedPrintStream</span> <span class="keyword">extends</span> <span class="title">PrintStreamOrWriter</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> PrintStream printStream;</span><br><span class="line">    </span><br><span class="line">        WrappedPrintStream(PrintStream printStream) &#123;</span><br><span class="line">            <span class="keyword">this</span>.printStream = printStream;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function">Object <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> printStream;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">println</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            printStream.println(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到直接<code>e.printStackTrace()</code>会打印到标准错误输出<code>System.err</code>，没办法保存异常堆栈信息以便后续处理且效率又低，<br>看上面代码可知<code>printStackTrace()</code>方法中有一个<code>synchronized(s.lock())</code>代码块，<br>直接使用<code>e.printStackTrace()</code>时<code>s.lock()</code>即为<code>System.err</code>，这样并发高时一次只能有一个线程打印，其他线程都阻塞了，<br>如果多个接口调用同一个工具类方法出错或者同时有多个请求调用同一个接口出错的情况下性能影响还是很大的。<br>有人会想为什么这里要用<code>synchronized</code>，我们假设不使用<code>synchronized</code>那就会导致多个线程同时一起打印，一会一行是a线程的，一会下一行可能就是b线程c线程的，<br>最后结果就是不同线程打印的日志相互穿插混在一起，如果日志没有打标签那就更没办法分析到底哪一行是哪个线程打印的，即使加了标签也还要过滤分组等一系列额外操作才能分开，<br>使用synchronized就能限制一次只有一个线程获取锁然后打印完日志到达锁边界释放锁，然后轮到别的线程继续打印，日志就不会相互穿插在一起。</p>
<p>所以上面使用了这样的写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CharArrayWriter cw = <span class="keyword">new</span> CharArrayWriter(<span class="number">1024</span>);</span><br><span class="line">PrintWriter pw = <span class="keyword">new</span> PrintWriter(cw, <span class="keyword">true</span>);</span><br><span class="line">e.printStackTrace(pw);</span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream(<span class="number">1024</span>);</span><br><span class="line">e.printStackTrace(<span class="keyword">new</span> PrintWriter(bos));</span><br></pre></td></tr></table></figure></p>
<p>将异常堆栈信息高效写入到内存中的一个字节数组，然后转化为字符串提交给日志收集系统做进一步处理。</p>
<hr>
<p>最后就是关于异常的一点优化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配合全局异常捕获&#123;<span class="doctag">@link</span> ExceptionHandlerImpl&#125;</span></span><br><span class="line"><span class="comment"> * 可以在任意位置中断并返回统一的错误Response,</span></span><br><span class="line"><span class="comment"> * 避免错误状态码层层传递到controller后才能返回错误Response,</span></span><br><span class="line"><span class="comment"> * 同时不用记录出错堆栈信息,</span></span><br><span class="line"><span class="comment"> * 兼顾代码方便整洁与性能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbortException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code = ErrorCode.CODE_400;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbortException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbortException</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbortException</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorCode.getMessage(), <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        code = errorCode.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此类仅为了在不同时机时中断程序,无需记录异常堆栈信息,</span></span><br><span class="line"><span class="comment">     * 为了提高性能直接覆盖父类&#123;<span class="doctag">@link</span> Throwable#fillInStackTrace()&#125;追踪堆栈信息方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Throwable <span class="title">fillInStackTrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//super.fillInStackTrace();     //不需要堆栈信息,无需调用父类方法填充堆栈信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从java1.7开始Throwable多了一个这样构造方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  message the detail message.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cause the cause.  (A &#123;<span class="doctag">@code</span> null&#125; value is permitted,and indicates that the cause is nonexistent or unknown.)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> enableSuppression whether or not suppression is enabled or disabled</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> writableStackTrace whether or not the stack trace should be writable</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Throwable</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression, <span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (writableStackTrace) &#123;</span><br><span class="line">        fillInStackTrace();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stackTrace = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    detailMessage = message;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.cause = cause;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!enableSuppression)</span><br><span class="line">        suppressedExceptions = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fills in the execution stack trace. This method records within this</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Throwable&#125; object information about the current state of the stack frames for the current thread.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the stack trace of this &#123;<span class="doctag">@code</span> Throwable&#125; &#123;<span class="doctag">@linkplain</span></span></span><br><span class="line"><span class="comment"> * Throwable#Throwable(String, Throwable, boolean, boolean) is not writable&#125;, calling this method has no effect.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Throwable <span class="title">fillInStackTrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (stackTrace != <span class="keyword">null</span> ||</span><br><span class="line">        backtrace != <span class="keyword">null</span> <span class="comment">/* Out of protocol state */</span> ) &#123;</span><br><span class="line">        fillInStackTrace(<span class="number">0</span>);</span><br><span class="line">        stackTrace = UNASSIGNED_STACK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过构造方法控制是否记录异常堆栈信息或者干脆直接覆盖<code>fillInStackTrace()</code>方法，经过这样简单两步我们就得到一个非常轻量级异常。</p>
<p>我们知道出现异常时，异常记录出错时堆栈信息也是很影响性能的，大部分情况我们需要知道出错原因就必须记录错误堆栈信息来分析，<br>但在一些特殊情况下我们已经知道原因，只想返回出错信息，不需要记录异常堆栈信息，上面这个轻量级异常就有很大用武之地了，<br>举一个很常见的场景，假如Controller层有一个接口通过Service调用了一个工具类，工具类会有好几种不同错误结果和正常结果，<br>我们可能会设置一个返回值，Service根据返回值生成不同结果返回给Controller，这样的话每次工具类多几种不同结果，Service也要相应改，<br>再假如很多个Service都调用了这个工具类，用这种方法就将是一个噩梦。</p>
<p>这个时候用上面的轻量级异常配合统一异常捕获，那Controller层就不用再关心工具类会返回多少不同结果了，直接在工具类里面根据不同结果抛出异常，<br>最终通过ExceptionHandlerImpl直接返回错误信息给用户，当然这里只列举了一个普通简单场景，实际情况下用处跟方便性更大，具体好处只有等用到具体项目中才会有体会。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/02/SSH端口转发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/02/SSH端口转发/" itemprop="url">SSH端口转发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-02T21:17:22+08:00">
                2016-12-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2016-12-03T14:09:01+08:00">
                2016-12-03
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于ssh端口转发科普类的相关文章已经很多了，需要科普基础入门的同学请先阅读其他文章后再读本文会有不一样的收获。<br>看过铺天盖地相关文章，不是抄来抄去讲不清楚就是断章取义关键地方一笔带过，实在是浪费时间误导他人。<br>后来发现这两篇文章值得一读<br><strong><a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Tunnels" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Tunnels</a></strong><br><strong><a href="https://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html" target="_blank" rel="noopener">https://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html</a></strong><br>英语还过得去的话建议直接看ssh帮助文档，关于端口转发部分文档描述如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">本地端口转发</span><br><span class="line">-L [bind_address:]port:host:hostport</span><br><span class="line">-L [bind_address:]port:remote_socket</span><br><span class="line">-L local_socket:host:hostport</span><br><span class="line">-L local_socket:remote_socket</span><br><span class="line"></span><br><span class="line">Specifies that connections to the given TCP port or Unix socket on the local (client) host are to be forwarded</span><br><span class="line">to the given host and port, or Unix socket, on the remote side.  This works by allocating a socket to listen to</span><br><span class="line">either a TCP port on the local side, optionally bound to the specified bind_address, or to a Unix socket.</span><br><span class="line">Whenever a connection is made to the local port or socket, the connection is forwarded over the secure channel,</span><br><span class="line">and a connection is made to either host port hostport, or the Unix socket remote_socket, from the remote machine.</span><br><span class="line"></span><br><span class="line">Port forwardings can also be specified in the configuration file.  Only the superuser can forward privileged</span><br><span class="line">ports.  IPv6 addresses can be specified by enclosing the address in square brackets.</span><br><span class="line"></span><br><span class="line">By default, the local port is bound in accordance with the GatewayPorts setting.  However, an explicit</span><br><span class="line">bind_address may be used to bind the connection to a specific address.  The bind_address of “localhost” indi‐</span><br><span class="line">cates that the listening port be bound for local use only, while an empty address or ‘*’ indicates that the</span><br><span class="line">port should be available from all interfaces.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">动态端口转发</span><br><span class="line">-D [bind_address:]port</span><br><span class="line"></span><br><span class="line">Specifies a local “dynamic” application-level port forwarding.  This works by allocating a socket to listen to</span><br><span class="line">port on the local side, optionally bound to the specified bind_address.  Whenever a connection is made to this</span><br><span class="line">port, the connection is forwarded over the secure channel, and the application protocol is then used to deter‐</span><br><span class="line">mine where to connect to from the remote machine.  Currently the SOCKS4 and SOCKS5 protocols are supported, and</span><br><span class="line">ssh will act as a SOCKS server.  Only root can forward privileged ports.  Dynamic port forwardings can also be</span><br><span class="line">specified in the configuration file.</span><br><span class="line"></span><br><span class="line">IPv6 addresses can be specified by enclosing the address in square brackets.  Only the superuser can forward</span><br><span class="line">privileged ports.  By default, the local port is bound in accordance with the GatewayPorts setting.  However,</span><br><span class="line">an explicit bind_address may be used to bind the connection to a specific address.  The bind_address of</span><br><span class="line">“localhost” indicates that the listening port be bound for local use only, while an empty address or ‘*’ indi‐</span><br><span class="line">cates that the port should be available from all interfaces.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">远程端口转发</span><br><span class="line">-R [bind_address:]port:host:hostport</span><br><span class="line">-R [bind_address:]port:local_socket</span><br><span class="line">-R remote_socket:host:hostport</span><br><span class="line">-R remote_socket:local_socket</span><br><span class="line">-R [bind_address:]port</span><br><span class="line"></span><br><span class="line">Specifies that connections to the given TCP port or Unix socket on the remote (server) host are to be forwarded</span><br><span class="line">to the local side.</span><br><span class="line"></span><br><span class="line">This works by allocating a socket to listen to either a TCP port or to a Unix socket on the remote side.  When‐</span><br><span class="line">ever a connection is made to this port or Unix socket, the connection is forwarded over the secure channel, and</span><br><span class="line">a connection is made from the local machine to either an explicit destination specified by host port hostport,</span><br><span class="line">or local_socket, or, if no explicit destination was specified, ssh will act as a SOCKS 4/5 proxy and forward</span><br><span class="line">connections to the destinations requested by the remote SOCKS client.</span><br><span class="line"></span><br><span class="line">Port forwardings can also be specified in the configuration file.  Privileged ports can be forwarded only when</span><br><span class="line">logging in as root on the remote machine.  IPv6 addresses can be specified by enclosing the address in square brackets.</span><br><span class="line"></span><br><span class="line">By default, TCP listening sockets on the server will be bound to the loopback interface only.  This may be</span><br><span class="line">overridden by specifying a bind_address.  An empty bind_address, or the address ‘*’, indicates that the remote</span><br><span class="line">socket should listen on all interfaces.  Specifying a remote bind_address will only succeed if the server&apos;s</span><br><span class="line">GatewayPorts option is enabled (see sshd_config(5)).</span><br><span class="line"></span><br><span class="line">If the port argument is ‘0’, the listen port will be dynamically allocated on the server and reported to the</span><br><span class="line">client at run time.  When used together with -O forward the allocated port will be printed to the standard out‐put.</span><br></pre></td></tr></table></figure></p>
<p>可以看到新版ssh不光支持端口转发还支持socket转发，当然socket转发这不是本文的重点，有兴趣的还可以了解一下socat。<br>使用ssh端口转发服务器sshd配置文件AllowTcpForwarding需设置为yes，ssh目前支持三种模式端口转发：</p>
<p><strong>本地端口转发</strong></p>
<p>本地端口转发作用是将本地端口连接转发到远程服务器，常用来连接远程服务器不能直接访问的端口。</p>
<p>最常见的将本地3306端口转发至远程3306端口<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -L localhost:3306:localhost:3306 user@server</span><br></pre></td></tr></table></figure></p>
<p>再复杂一点，整个后台只有一台网关服务器对外开放，其他服务器全部处于一个跟网关服务器在同一局域网的环境下，不对外开放无法直接连接，只能通过网关服务器连接，在网关服务器同一局域网下有一台mysql服务器，局域网ip为192.168.10.6,正常情况下我们要连接到这台mysql服务器要先登录到网关服务器，然后再在网关服务器上连接数据库，<br>那有没有办法可以直接连上内网的那台mysql服务器呢，根据上面ssh帮助文档<code>-L [bind_address:]port:host:hostport</code>，可以运行以下命令：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -L localhost:3306:192.168.10.6:3306 user@gateway</span><br></pre></td></tr></table></figure></p>
<p><code>-L [bind_address:]port:host:hostport</code>可以看到这里的bind_address是可选的，通常情况下很多人都是直接省略掉bind_address，那么命令就简化为<br><code>ssh -vN -L 3306:192.168.10.6:3306 user@gateway</code>，bind_address为空或者为*这也就意味着跟你处于同一局域网或者可以访问到你电脑的人也可以连接你这个端口进而连接上数据库。<br>有人会困惑<code>ssh -vN -L localhost:3306:192.168.10.6:3306 user@gateway</code>这里的host值192.168.10.6，这里的192.168.10.6是站在user@gateway这台服务器角度上来看的，并不是站在用户本地角度来说的。<br>运行上面命令后连接本地的3306端口，会通过ssh隧道传到gateway服务器，gateway服务器又将连接传到192.168.10.6的3306端口，<br>只要访问本地3306端口就能访问到在网关后面的局域网mysql服务器。</p>
<p>再进一步更麻烦的环境，在上面基础上，为了保证安全，网关服务器的ssh也不允许直接连接，需要先通过一台跳板机来访问，连接跳板机需要动态验证码或者GoogleAuthenticator，这种情况下还想直接连接到那台mysql服务器该怎么办呢，正常情况下要先登录跳板机，再从跳板机登录到网关服务器，每次连接两下显然太麻烦，也有很多文章讲穿越跳板机一步直接连接的方法，<br>都是借助<code>ProxyCommand ssh -W %h:%p jump</code>或<code>ssh -o ProxyCommand=&quot;ssh -W %h:%p jump&quot; gateway</code>,这样虽然可以，但是有一个很大限制就是当跳板机跟网关服务器上ssh用户名、密钥、端口不一样时就不能用了，<br>好在新版本的ssh提供了一个ProxyJump选项，比都是借助ProxyCommand更加灵活，用法为:<code>ssh -J a@jump b@gateway</code>或<code>ssh -o ProxyJump=&quot;a@jump:2333&quot; gateway</code>,跳板机也可以指定多个。<br>有了ProxyJump上面场景就好解决，直接运行<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -J user@jump -L localhost:3306:192.168.10.6:3306 user@gateway</span><br></pre></td></tr></table></figure></p>
<p><strong>动态端口转发</strong></p>
<p>动态端口转发通常用来做socks代理，用法最简单：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -D 1080 server</span><br></pre></td></tr></table></figure></p>
<p>假如server为一台香港或国外服务器，在你本地电脑上运行上面命令，然后chrome设置启动参数<code>--proxy-server=&quot;socks5://127.0.0.1:1080&quot;</code>给chrome设置本地socks代理服务器就能直接访问google查询资料，也正因如此ssh连接经常受到干扰不稳定时快时慢。<br>本来是不想写这段的，因为博客很容易因此被屏蔽、被dns污染，但用google能搜索到一些质量更高的文章，设置ssh代理自己用就很方便。</p>
<p><strong>远程端口转发</strong></p>
<p>远程端口转发通常大家叫反向端口转发，作用是将远程端口连接转发到本地，通常用来做内网穿透，其他内网穿透工具有frp、ngrok之类的。</p>
<p>比如说你想随时远程控制自己的电脑，但通常情况下普通个人宽带是没有固定ip的，端口也不能直接访问需要在路由器上做端口映射，反正就是各种限制，想让自己的ssh或vnc端口可以直接被访问到就需要做内网穿透，方案有很多，最方便安全的莫过于ssh了，但ssh只支持tcp不支持udp转发，这是唯一不便的地方。</p>
<p>要想将你电脑的vnc、远程桌面映射到公网可以在你电脑的上直接运行：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -R 6666:localhost:5900 user@server</span><br></pre></td></tr></table></figure></p>
<p>其中server是一台有公网固定ip或域名可以被直接访问到的服务器，这样当你直接访问server的6666端口时连接就被server的ssh转发到你电脑的5900端口，也就意味着你可以直接通过vnc连接server:6666就能连接到你的电脑。</p>
<p>服务器sshd配置文件中GatewayPorts选项会影响端口绑定地址，配置不同值会影响端口访问，先看下说明文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GatewayPorts</span><br><span class="line">     Specifies whether remote hosts are allowed to connect to ports forwarded for the client.  By default, sshd(8) binds remote port</span><br><span class="line">     forwardings to the loopback address.  This prevents other remote hosts from connecting to forwarded ports.  GatewayPorts can be</span><br><span class="line">     used to specify that sshd should allow remote port forwardings to bind to non-loopback addresses, thus allowing other hosts to</span><br><span class="line">     connect.  The argument may be no to force remote port forwardings to be available to the local host only, yes to force remote</span><br><span class="line">     port forwardings to bind to the wildcard address, or clientspecified to allow the client to select the address to which the for‐</span><br><span class="line">     warding is bound.  The default is no.</span><br></pre></td></tr></table></figure></p>
<p>也就是说默认情况下GatewayPorts为no，将只监听远程服务器本地端口访问，不接受其他机器访问，表象就是你访问不到远程服务器转发端口，这时你会以为转发失败，实际上看ssh的debug日志可以发现端口转发成功，只不过端口监听的是loopback地址其他机器无法直接访问，要想直接访问有两个办法：<br>1、服务器sshd配置文件中GatewayPorts设置为yes或clientspecified；<br>2、用上一节的本地端口转发办法将本地端口转发到远程端口；</p>
<p><code>ssh -vN -R 6666:localhost:5900 user@server</code>这里也不仅限于localhost，为localhost时代表你的电脑，也可以为其他跟你在统一局域网下的其他电脑，比如现在有一台跟你电脑在同一局域网下<br>ip为192.168.2.20的你朋友的电脑，你想远程访问到这台电脑的3389端口，可以在你电脑上运行(注意是在你电脑上，不是你朋友电脑，如果是在你朋友电脑上的话直接运行上面介绍的命令就够了)：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -R 6666:192.168.2.20:3389 user@server</span><br></pre></td></tr></table></figure></p>
<p>这样当你访问server的6666端口时连接被转发到你的电脑上，你的电脑又将连接传到192.168.2.20:3389，直接连接server的6666端口就能连接上你朋友电脑的3389远程桌面。</p>
<p>再举一个更常见的例子，前端在接微信公众号、扫码授权登录等很多其它场景时需要设置一个回调地址，这个回调地址必须是微信能直接访问到的，一般都设置为测试环境服务器地址，但这样有一个不方便的地方，<br>每次修改都要上传到测试环境才能看到效果，不方便调试又麻烦，有没有办法让前端能直接在他本地调试呢，答案是肯定的，假设那个做前端的同事电脑ip为192.168.6.110，在你电脑上可以直接访问到他电脑，<br>那么你可以在你电脑上运行：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -vN -R 8080:192.168.2.20:80 user@devserver</span><br></pre></td></tr></table></figure></p>
<p>然后在上面设置回调地址时直接设置devserver:8080，这样当访问测试环境服务器devserver:8080时就能直接访问到你前端同事的电脑。</p>
<p>内网穿透由于受到网络环境影响及其它不可描述的干扰因素，要想保证可靠稳定就必须采取一些额外措施来保证ssh隧道可靠性，google搜索reliable ssh tunnel找到一系列文章有一些方案，比如使用autossh和设置心跳保活，<br>这些在一定程度上提高了稳定性但还远远不够，离稳定可靠还有不小距离。</p>
<p>通过找到的方案并经过一些尝试，就有了一个下面可以达到98%稳定可靠的办法，想要达到100%可靠估计只能靠vpn了。<br>在讲办法之前先介绍一点ssh技巧，借助ssh的config文件我们可以简化很多操作提高使用效率，先来看我的ssh配置文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Host *</span><br><span class="line">    ControlMaster auto</span><br><span class="line">    ControlPath /dev/shm/session_%r@%h:%p</span><br><span class="line">    ControlPersist 8h</span><br><span class="line">    ServerAliveInterval 200</span><br><span class="line">    ServerAliveCountMax 6</span><br><span class="line">    Compression yes</span><br><span class="line">    GSSAPIAuthentication no</span><br><span class="line">    PreferredAuthentications publickey</span><br><span class="line">    </span><br><span class="line">Host jump</span><br><span class="line">    HostName xxx</span><br><span class="line">    User xxx</span><br><span class="line">    Port xxx</span><br><span class="line">    IdentityFile ~/.ssh/jump</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host dev</span><br><span class="line">    HostName xxx</span><br><span class="line">    User xxx</span><br><span class="line">    Port xxx</span><br><span class="line">    IdentityFile ~/.ssh/dev</span><br><span class="line">    ProxyJump jump</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host ali</span><br><span class="line">    HostName 47.75.xx.xx</span><br><span class="line">    User xxx</span><br><span class="line">    Port 443</span><br><span class="line">    IdentityFile ~/.ssh/ali</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host github*</span><br><span class="line">    HostName github.com</span><br><span class="line">    User git</span><br><span class="line">    IdentityFile ~/.ssh/git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host tunnel</span><br><span class="line">    ControlMaster no</span><br><span class="line">    HostName xxx</span><br><span class="line">    User xxx</span><br><span class="line">    Port 443</span><br><span class="line">    IdentityFile ~/.ssh/tunnel</span><br><span class="line">    IdentitiesOnly yes</span><br><span class="line">    ExitOnForwardFailure yes</span><br><span class="line">    BatchMode yes</span><br><span class="line">    ConnectTimeout 20</span><br><span class="line">    ConnectionAttempts 3</span><br><span class="line">    ServerAliveInterval 200</span><br><span class="line">    ServerAliveCountMax 2</span><br><span class="line">    StrictHostKeyChecking no</span><br><span class="line">    #RemoteForward 127.0.0.1:2333 127.0.0.1:233</span><br><span class="line">    #RemoteForward 127.0.0.1:5900 127.0.0.1:5900</span><br><span class="line">    #LocalForward 127.0.0.1:3306 127.0.0.1:3306</span><br></pre></td></tr></table></figure></p>
<p>至于上述配置文件每一项具体意思不在本文讨论范围内，还有更多选项可以通过man ssh_config查看，我只讲几个关键的地方，设置ServerAliveInterval、ServerAliveCountMax这些常见保活手段就不多说，<br>这里tunnel部分最主要的是增加了一个配置选项<code>ExitOnForwardFailure</code>，设置当ssh端口转发失败时退出再结合重连脚本就能进一步增强ssh隧道稳定性。</p>
<p>对于Linux系统，可以创建一个服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=SSHTunnel Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=nobody</span><br><span class="line">ExecStart=/usr/bin/ssh -F /var/ssh_config -4NT -R 5900:localhost:5900 -R 2333:localhost:233 tunnel</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=20</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>或者使用一个这样的脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash -x</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((;;)) &#123;</span><br><span class="line">    ssh -4vNT -R 5900:localhost:5900 -R 2333:localhost:233 tunnel;</span><br><span class="line">    sleep 20;</span><br><span class="line">    </span><br><span class="line">    ssh -4vNT -R 6666:localhost:5900 -R 8888:localhost:233 tunnel;</span><br><span class="line">    sleep 20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>把ssh连接放在一个无限循环中保证断开后会重连，同时设置两组端口，至于原因后面再讲，最关键的还是<code>ExitOnForwardFailure yes</code>设置了这个选项才能保证端口转发一定成功否则就<br>不停重试，用autossh也可以重连但是有时候虽然ssh重新连接成功但是端口转发却失败所以需要通过ExitOnForwardFailure控制重连，所以只用autossh是无法保证ssh隧道稳定的，<br>试验过多次发现有时候ssh重连时由于远程端口的连接还未及时释放，此时ssh重连后无法再次监听同一端口因为端口还被占用着，虽然ssh重连成功但端口转发失败ssh隧道无法使用，这也是单使用autossh<br>无法解决隧道稳定的问题，好在ssh配置灵活提供了<code>ExitOnForwardFailure</code>供用户选择，转发失败就退出再重连这样就能保证稳定。<br>这里出现问题的主要原因是ssh重连时无法监听之前连接还占用着的端口，因此这里设置了两组端口换着使用从一定程度上减少端口冲突使端口有充分时间释放，这是一种选择，但这也不能从根本上解决问题，<br>要想从根本上解决问题需要kill掉之前连接，最简单无脑的办法就是在上面脚本中加上一句清除之前连接语句：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash -x</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((;;)) &#123;</span><br><span class="line">    ssh -4vN -R 5900:localhost:5900 -R 2333:localhost:233 tunnel;</span><br><span class="line">    ssh tunnel pkill ssh;</span><br><span class="line">    sleep 20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样简单粗暴干净，但是缺点是会kill掉以当前用户身份登录的所有ssh连接，如果是你多个ssh连接使用同一个账户的话都会被kill掉，不过一般如果做端口转发的话会单独分配一个最低权限不能登录shell的用户就不考虑这种情况。</p>
<p>对于使用Windows系统的，可以用cygwin或MinGW里面的ssh，然后创建一个批处理脚本D:\Tunnel.bat：<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line">:loop</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -------------------------------<span class="variable">%date%</span><span class="variable">%time%</span>-------------------------------- &gt;&gt;  D:\tunnel.log</span><br><span class="line"></span><br><span class="line">ssh.exe -F D:\config -i D:\tunnel -<span class="number">4</span>vNT -R <span class="number">8888</span>:localhost:<span class="number">5900</span> -R <span class="number">6666</span>:localhost:<span class="number">3389</span> tunnel &gt;&gt; D:\tunnel.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">choice /t <span class="number">10</span> /d y /n /m "<span class="number">10</span>s后重试"</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -------------------------------<span class="variable">%date%</span><span class="variable">%time%</span>-------------------------------- &gt;&gt;  D:\tunnel.log</span><br><span class="line"></span><br><span class="line">ssh.exe -F D:\config -i D:\tunnel -<span class="number">4</span>vNT -R <span class="number">3389</span>:localhost:<span class="number">3389</span> -R <span class="number">5900</span>:localhost:<span class="number">5900</span> tunnel &gt;&gt; D:\tunnel.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">choice /t <span class="number">20</span> /d y /n /m "<span class="number">20</span>s后重试"</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> loop</span><br></pre></td></tr></table></figure></p>
<p>再写一个守护任务脚本daemon.bat：<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> -------------------------------<span class="variable">%date%</span><span class="variable">%time%</span> 守护任务执行-------------------------------- &gt;&gt;  D:\daemon.log</span><br><span class="line">wmic process where name='<span class="built_in">cmd</span>.exe' get commandline | <span class="built_in">findstr</span> /i "tunnel" || <span class="built_in">start</span> /min D:\Tunnel.bat</span><br></pre></td></tr></table></figure></p>
<p>然后创建一个任务计划<code>schtasks /create /ru SYSTEM /sc onstart /tn &quot;SSHTunnel&quot; /tr &quot;D:\daemon.bat&quot;</code>,还可以再设置一个触发器每隔15分钟运行检测一次增强ssh隧道稳定。</p>
<p>写在最后，附上我个人远程控制家里电脑的办法，首先我有一个可以刷OpenWrt或PandoraBox的路由器，有了这个路由器一切都好办了，路由器上直接运行上面的脚本就可以把路由器的ssh端口穿透出去，路由器唤醒电脑的话可以用主板自带的Wake on Lan功能，<br>当然还有另外一个办法，电脑可以设置成键盘鼠标开机，在家里放个小手机调成震动模式，要想远程开机直接打电话给手机，手机震动触发键盘鼠标开机。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/02/IDEA重置试用时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="X">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Timelessx">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/02/IDEA重置试用时间/" itemprop="url">IDEA重置试用时间</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-02T20:08:01+08:00">
                2016-05-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-01-25T15:37:20+08:00">
                2019-01-25
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p><strong>条件允许的话请直接支持正版<a href="https://www.jetbrains.com/idea/buy/" target="_blank" rel="noopener">https://www.jetbrains.com/idea/buy/</a></strong><br><strong>学生或教师有edu邮箱可以去申请学生授权<a href="https://www.jetbrains.com/student/" target="_blank" rel="noopener">https://www.jetbrains.com/student/</a></strong></p>
<hr>
<p>正常情况下IDEA旗舰版试用时间是30天，试用结束后就需要激活，随便搜索一下也能找到各种破解补丁和激活服务器，<br>但大多都不太稳定，激活补丁也可能有潜在的危险。当然有人会说修改系统时间至未来再试用就不会过期，以前可以现在已经失效了，<br>于是就找到了下面的重置试用时间的方法:</p>
<p>我用的是Linux系统，同时也将IDEA的配置文件修改到了IDEA安装目录下的config文件夹下，在IDEA安装目录下直接执行以下脚本即可:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">rm -f ./config/<span class="built_in">eval</span>/*</span><br><span class="line"><span class="comment">#sed -i '/evlsprt/d' ./config/options/options.xml</span></span><br><span class="line">sed -i <span class="string">'/evlsprt/d'</span> ./config/options/other.xml</span><br><span class="line">rm -rf ~/.java/.userPrefs</span><br></pre></td></tr></table></figure>
<p>如果没有修改过配置修改文件夹，默认配置文件路径为<code>~/.IntelliJIdea*/config/</code>，替换一下上面路径即可。</p>
<p>不想用脚本也可以自己手动来改:</p>
<ul>
<li>删除配置文件夹下的eval文件夹</li>
<li>删除配置文件夹下的options内的<code>options.xml</code>或<code>other.xml</code>里面所有name为evlsprt*的行(其实也可以直接删除这个xml文件，只不过这里面存储的部分设置没了而已)</li>
<li>删除<code>~/.java/.userPrefs</code>这个文件夹</li>
</ul>
<p><strong>注意</strong></p>
<ol>
<li>如果IDEA版本是2018.3之前版本，删除配置文件下的options内的<code>options.xml</code>的所有name为evlsprt*的行</li>
<li>如果IDEA版本是2018.3版本，配置文件变了，options目录下的<code>options.xml</code>没有了，变成了<code>other.xml</code>，需要删除<code>other.xml</code>的所有name为evlsprt*的行，这个也是升级到新版后才发现的</li>
</ol>
<hr>
<p>对于Windows系统，方法也大致相同，可以用以下批处理脚本:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">cd</span> /d "<span class="variable">%USERPROFILE%</span>\.IntelliJIdea*\config"</span><br><span class="line"><span class="built_in">rmdir</span> /s /q "eval"</span><br><span class="line">::<span class="built_in">del</span> "options\options.xml"</span><br><span class="line"><span class="built_in">del</span> "options\other.xml"</span><br><span class="line">reg delete "HKEY_CURRENT_USER\Software\JavaSoft\Prefs\jetbrains\idea" /f</span><br></pre></td></tr></table></figure>
<p>上面是针对使用默认位置配置文件的方法，如果自己改了路径修改下即可，伸手党可以直接点左上角关闭按钮离开了。</p>
<p>手动操作步骤：</p>
<ul>
<li>删除配置文件夹下的eval文件夹</li>
<li>删除配置文件夹下的options内的<code>options.xml</code>或<code>other.xml</code>里面所有name为evlsprt*的行(同Linux根据IDEA版本选择<code>options.xml</code>还是<code>other.xml</code>)</li>
<li>删除注册表项<code>HKEY_CURRENT_USER\Software\JavaSoft\Prefs\jetbrains\idea</code></li>
</ul>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">X</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">X</span>

  
</div>

<!-- 





  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>



 -->
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


  <!--  -->

  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
